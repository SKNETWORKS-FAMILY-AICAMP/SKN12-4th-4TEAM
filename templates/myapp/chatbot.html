{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš½ Ballzzi AI ì±—ë´‡</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

</head>
<body>
    <div class="chat-header">
        <a href="/" class="back-button">
            <i class="fas fa-arrow-left"></i>
            <span>í™ˆìœ¼ë¡œ</span>
        </a>
        <h1>âš½ Ballzzi AI ì±—ë´‡</h1>
        <p>ì¶•êµ¬ ì„ ìˆ˜ ì •ë³´ì™€ HR ê´€ë ¨ ì§ˆë¬¸ì— ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤</p>
    </div>

    <div class="chat-container">
        <div id="chat-window" class="chat-window">
            <div id="welcome-message" class="welcome-message">
                <img src="{% static 'icons/ballzzi.png' %}" alt="Ballzzi AI" class="welcome-chatbot-icon">
                <h2>ì•ˆë…•í•˜ì„¸ìš”! Ballzzi AI ì±—ë´‡ì…ë‹ˆë‹¤</h2>
                <p>ì¶•êµ¬ ì„ ìˆ˜ ì •ë³´ë‚˜ HR ê´€ë ¨ ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ ë¬¼ì–´ë³´ì„¸ìš”.<br>
                ì•„ë˜ ì˜ˆì‹œ ì§ˆë¬¸ì„ í´ë¦­í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ë³´ì„¸ìš”!</p>
                
                <div class="example-tags">
                    <button class="example-tag" data-question="ì†í¥ë¯¼ì— ëŒ€í•´ ì•Œë ¤ì¤˜">âš½ ì†í¥ë¯¼ ì •ë³´</button>
                    <button class="example-tag" data-question="ë¦¬ì˜¤ë„¬ ë©”ì‹œì˜ íŠ¹ì§•ì€?">ğŸŒŸ ë©”ì‹œ íŠ¹ì§•</button>
                    <button class="example-tag" data-question="ì—°ì°¨ëŠ” ì–´ë–»ê²Œ ì¨ìš”?">ğŸ“… ì—°ì°¨ ì‚¬ìš©ë²•</button>
                    <button class="example-tag" data-question="ì¶œì¥ë¹„ëŠ” ì–´ë–»ê²Œ ì²˜ë¦¬í•´ìš”?">ğŸ’¼ ì¶œì¥ë¹„ ì²˜ë¦¬</button>
                    <button class="example-tag" data-question="í˜¸ë‚ ë‘ì™€ ë©”ì‹œ ì¤‘ ëˆ„ê°€ ë” ì¢‹ì•„?">âš½ ì„ ìˆ˜ ë¹„êµ</button>
                </div>
            </div>
            
            {% for msg in chat_messages %}
                <div class="chat-message {% if msg.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                    <div class="message-avatar">
                        {% if msg.role == 'user' %}
                            <i class="fas fa-user"></i>
                        {% else %}
                            <img src="{% static 'icons/ballzzi.png' %}" alt="AI" class="ai-avatar-img">
                        {% endif %}
                    </div>
                    <div class="message-bubble">
                        {% if msg.image_url %}
                            <img src="{{ msg.image_url }}" alt="{{ msg.image_caption }}" class="message-image">
                        {% endif %}
                        {{ msg.content|safe }}
                    </div>
                </div>
            {% endfor %}
            
            <div id="spinner" class="spinner-overlay" style="display: none;">
                <div class="loading-image-container">
                    <img src="{% static 'icons/angry_ballzzi.png' %}" class="loading-image active" alt="ë¡œë”© ì¤‘...">
                    <img src="{% static 'icons/ballzzi.png' %}" class="loading-image" alt="ë¡œë”© ì¤‘...">
                    <img src="{% static 'icons/evil_ballzzi.png' %}" class="loading-image" alt="ë¡œë”© ì¤‘...">
                    <img src="{% static 'icons/sad_ballzzi.png' %}" class="loading-image" alt="ë¡œë”© ì¤‘...">
                </div>
            </div>
        </div>

        <form id="chat-form">
            <div class="input-container">
                <input type="text" id="user-input" class="input-field" 
                       placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ì†í¥ë¯¼ì€ ì–´ë–¤ ì„ ìˆ˜ì•¼?)" 
                       autocomplete="off">
                <button type="submit" id="submit-button" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- JavaScript -->
    <script>
    // ì´ë¯¸ì§€ ìˆœí™˜ì„ ì œì–´í•  íƒ€ì´ë¨¸ ë³€ìˆ˜
    let loadingInterval;
    let currentLoadingIndex = 0; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

    // CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (Django ë³´ì•ˆ í•„ìˆ˜)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- í˜ì´ì§€ ìš”ì†Œ ì„ íƒ ---
    const csrfToken = getCookie('csrftoken');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatWindow = document.getElementById('chat-window');
    const spinner = document.getElementById('spinner');
    const welcomeMessage = document.getElementById('welcome-message');
    const exampleTags = document.querySelectorAll('.example-tag');
    const submitButton = document.getElementById('submit-button');

    // --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ ì •ì˜ ---

    // ë‹µë³€ì„ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function appendMessage(role, content, extraClass = '') {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', role === 'user' ? 'user-message' : 'assistant-message');

        const avatar = document.createElement('div');
        avatar.classList.add('message-avatar');
        avatar.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : `<img src="{% static 'icons/ballzzi.png' %}" alt="AI" class="ai-avatar-img">`;

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');
        if (extraClass) {
            bubble.classList.add(extraClass);
        }

        if (role === 'user') {
            bubble.innerText = content;
        } else {
            bubble.innerHTML = content;
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
    }
    
    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ í•¨ìˆ˜
    function startLoadingAnimation() {
        if (!spinner) return;
        spinner.style.display = 'flex';
        const loadingImages = document.querySelectorAll('.loading-image');
        currentLoadingIndex = 0; // ì‹œì‘ ì‹œ 0ìœ¼ë¡œ ì´ˆê¸°í™”

        if (loadingImages.length > 0) {
            clearInterval(loadingInterval);
            loadingImages.forEach(img => img.classList.remove('active'));
            loadingImages[currentLoadingIndex].classList.add('active');

            loadingInterval = setInterval(() => {
                loadingImages[currentLoadingIndex].classList.remove('active');
                currentLoadingIndex = (currentLoadingIndex + 1) % loadingImages.length;
                loadingImages[currentLoadingIndex].classList.add('active');
            }, 1000);
        }
    }

    // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì •ì§€ í•¨ìˆ˜
    function stopLoadingAnimation() {
        if (!spinner) return;
        spinner.style.display = 'none';
        clearInterval(loadingInterval);
    }

    // ì„œë²„ì— ì§ˆë¬¸ì„ ë³´ë‚´ê³  ë‹µë³€ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
    async function handleFormSubmit(e) {
        e.preventDefault();
        const prompt = userInput.value.trim();
        if (!prompt) return;

        if (welcomeMessage) {
            welcomeMessage.style.display = 'none';
        }

        appendMessage('user', prompt);
        userInput.value = '';
        submitButton.disabled = true;
        
        startLoadingAnimation();
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            const response = await fetch(`{% url "myapp:chatbot_page" %}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ question: prompt })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            stopLoadingAnimation();
            submitButton.disabled = false;

            // ë‹µë³€ ì¢…ë¥˜ì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            if (data.type === 'FM') {
                if (data.replies && data.replies.length > 0) {
                    for (const item of data.replies) {
                        const descriptionHtml = DOMPurify.sanitize(marked.parse(item.description));
                        const summaryHtml = `<strong>${item.name}</strong>`;
                        let content = `
                            <div class="response-grid-container">
                                <div class="grid-item-image">
                                    <img src="${item.image_url || ''}" alt="${item.name} ì‚¬ì§„" class="message-image-grid">
                                </div>
                                <div class="grid-item-summary">
                                    ${summaryHtml}
                                    <p class="summary-position">${item.position || 'ê³µê²©ìˆ˜'}</p>
                                </div>
                                <div class="grid-item-details">
                                    ${descriptionHtml}
                                </div>
                            </div>
                        `;
                        appendMessage('assistant', content);
                    }
                } else {
                    appendMessage('assistant', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¶•êµ¬ì„ ìˆ˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else if (data.type === 'HR') {
                // HR ë‹µë³€ì„ ìœ„í•œ ê³ ì • ì•„ì´ì½˜ URL
                const hrIconUrl = `{% static 'icons/hr_icon.png' %}`;
                const answerHtml = DOMPurify.sanitize(marked.parse(data.answer));

                // FMê³¼ ë‹¤ë¥¸, HR ì „ìš© ë ˆì´ì•„ì›ƒì„ ì‚¬ìš©í•˜ë ¤ë©´ ì—¬ê¸°ì„œ ë³„ë„ì˜ HTML êµ¬ì¡°ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
                // ì§€ê¸ˆì€ í…ìŠ¤íŠ¸ë§Œ í‘œì‹œí•˜ëŠ” 'hr-bubble'ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                appendMessage('assistant', answerHtml, 'hr-bubble'); 
            } else {
                const defaultAnswerHtml = DOMPurify.sanitize(marked.parse(data.answer || 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
                appendMessage('assistant', defaultAnswerHtml);
            }
            
            chatWindow.scrollTop = chatWindow.scrollHeight;

        } catch (error) {
            console.error('Error sending message:', error);
            stopLoadingAnimation();
            submitButton.disabled = false;
            appendMessage('assistant', 'ì£„ì†¡í•©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
    chatForm.addEventListener('submit', handleFormSubmit);

    exampleTags.forEach(tag => {
        tag.addEventListener('click', () => {
            userInput.value = tag.dataset.question;
            chatForm.dispatchEvent(new Event('submit'));
        });
    });

    // ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function appendMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message');
        messageDiv.classList.add(role === 'user' ? 'user-message' : 'assistant-message');

        const avatar = document.createElement('div');
        avatar.classList.add('message-avatar');
        avatar.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : `<img src="{% static 'icons/ballzzi.png' %}" alt="AI" class="ai-avatar-img">`;

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        if (role === 'user') {
            // ì‚¬ìš©ìì˜ ì…ë ¥ì€ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬í•˜ì—¬ HTML íƒœê·¸ê°€ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ í•¨
            bubble.innerText = content;
        } else {
            // AIì˜ ì‘ë‹µì€ ë³€í™˜ëœ HTMLì„ ê·¸ëŒ€ë¡œ ì‚½ì…
            bubble.innerHTML = content;
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
    }
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    window.addEventListener('load', function() {
        userInput.focus();
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

</script>
</body>
</html>